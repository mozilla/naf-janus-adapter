(function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={i:d,l:!1,exports:{}};return a[d].call(e.exports,e,e.exports,b),e.l=!0,e.exports}var c={};return b.m=a,b.c=c,b.d=function(a,c,d){b.o(a,c)||Object.defineProperty(a,c,{configurable:!1,enumerable:!0,get:d})},b.n=function(a){var c=a&&a.__esModule?function(){return a['default']}:function(){return a};return b.d(c,'a',c),c},b.o=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},b.p='',b(b.s=0)})([function(a,b,c){function d(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d('next',a)},function(a){d('throw',a)})}return d('next')})}}function e(){return Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}function f(a,b){return new Promise((c)=>{a.addEventListener(b,(a)=>c(a),{once:!0})})}let g=(()=>{var a=d(function*(){try{return yield navigator.mediaDevices.getUserMedia({audio:!0})}catch(a){'NotAllowedError'===a.name?console.warn('Microphone access not allowed.'):console.error(a)}});return function(){return a.apply(this,arguments)}})();var h=c(1);const i={Audio:1,Video:2,Data:4},j={iceServers:[{url:'stun:stun1.l.google.com:19302'},{url:'stun:stun2.l.google.com:19302'}]};class k{constructor(){this.room=null,this.userId=e(),this.serverUrl=null,this.ws=null,this.session=null,this.publisher=null,this.occupants={},this.occupantPromises={},this.onWebsocketMessage=this.onWebsocketMessage.bind(this),this.onDataChannelMessage=this.onDataChannelMessage.bind(this)}setServerUrl(a){this.serverUrl=a}setApp(){}setRoom(a){try{this.room=parseInt(a)}catch(a){throw new Error('Room must be a positive integer.')}}setWebRtcOptions(){}setServerConnectListeners(a,b){this.connectSuccess=a,this.connectFailure=b}setRoomOccupantListener(a){this.onOccupantsChanged=a}setDataChannelListeners(a,b,c){this.onOccupantConnected=a,this.onOccupantDisconnected=b,this.onOccupantMessage=c}connect(){this.ws=new WebSocket(this.serverUrl,'janus-protocol'),this.session=new h.JanusSession(this.ws.send.bind(this.ws)),this.ws.addEventListener('open',()=>this.onWebsocketOpen()),this.ws.addEventListener('message',this.onWebsocketMessage)}onWebsocketOpen(){var a=this;return d(function*(){yield a.session.create();var b=a.createPublisher();a.occupantPromises[a.userId]=b,a.publisher=yield b,a.connectSuccess(a.userId);for(let b of a.publisher.initialOccupants)b!==a.userId&&(a.occupantPromises[b]=a.addOccupant(b))})()}onWebsocketMessage(a){var b=JSON.parse(a.data);if(this.session.receive(b),b.plugindata&&b.plugindata.data){var c=b.plugindata.data;'join'===c.event?this.occupantPromises[c.user_id]=this.addOccupant(c.user_id):c.event&&'leave'===c.event&&this.removeOccupant(c.user_id)}}addOccupant(a){var b=this;return d(function*(){var c=yield b.createSubscriber(a);return b.onOccupantConnected(a),b.occupants[a]=!0,b.onOccupantsChanged(b.occupants),c})()}removeOccupant(a){this.occupants[a]&&(delete this.occupants[a],this.onOccupantDisconnected(a),this.onOccupantsChanged(this.occupants))}createPublisher(){var a=this;return d(function*(){var b=new h.JanusPluginHandle(a.session);yield b.attach('janus.plugin.sfu');var c=new RTCPeerConnection(j);c.addEventListener('icecandidate',function(a){b.sendTrickle(a.candidate)});var d=c.createDataChannel('unreliable',{ordered:!1,maxRetransmits:0});d.addEventListener('message',a.onDataChannelMessage);var e=c.createDataChannel('reliable',{ordered:!0});e.addEventListener('message',a.onDataChannelMessage);var i=yield g();i&&c.addStream(i);var k=yield c.createOffer();yield c.setLocalDescription(k);var l=yield b.sendJsep(k);yield c.setRemoteDescription(l.jsep),yield f(e,'open');var m=yield a.sendJoin(b,a.room,a.userId,!0),n=m.plugindata.data.response.user_ids;return{handle:b,initialOccupants:n,reliableChannel:e,unreliableChannel:d,mediaStream:i,peerConnection:c}})()}createSubscriber(a){var b=this;return d(function*(){var c=new h.JanusPluginHandle(b.session);yield c.attach('janus.plugin.sfu');var d=new RTCPeerConnection(j);d.addEventListener('icecandidate',function(a){c.sendTrickle(a.candidate)});var e=yield d.createOffer({offerToReceiveAudio:!0});yield d.setLocalDescription(e);var f=yield c.sendJsep(e);yield d.setRemoteDescription(f.jsep),yield b.sendJoin(c,b.room,b.userId,!1,[{publisher_id:a,content_kind:i.Audio}]);var g=d.getRemoteStreams(),k=0<g.length?g[0]:null;return{handle:c,mediaStream:k,peerConnection:d}})()}sendJoin(a,b,c,d,e){return a.sendMessage({kind:'join',room_id:b,user_id:c,notify:d,subscription_specs:e})}onDataChannelMessage(a){var b=JSON.parse(a.data);b.dataType&&this.onOccupantMessage(null,b.dataType,b.data)}shouldStartConnectionTo(){return!0}startStreamConnection(){}closeStreamConnection(){}getConnectStatus(a){return this.occupants[a]?NAF.adapters.IS_CONNECTED:NAF.adapters.NOT_CONNECTED}getMediaStream(a){var b=this.occupantPromises[a];if(!b)throw new Error(`Subscriber for client: ${a} does not exist.`);return b.then((a)=>a.mediaStream)}enableMicrophone(a){var b=this.subscriber.mediaStream;if(b){var c=b.getAudioTracks();0<c.length&&(c[0].enabled=a)}}sendData(a,b,c){this.publisher.unreliableChannel.send(JSON.stringify({clientId:a,dataType:b,data:c}))}sendDataGuaranteed(a,b,c){this.publisher.reliableChannel.send(JSON.stringify({clientId:a,dataType:b,data:c}))}broadcastData(a,b){this.publisher.unreliableChannel.send(JSON.stringify({dataType:a,data:b}))}broadcastDataGuaranteed(a,b){this.publisher.reliableChannel.send(JSON.stringify({dataType:a,data:b}))}}NAF.adapters.register('janus',k),a.exports=k},function(a){function b(a){this.session=a,this.id=void 0}function c(a,b){this.output=a,this.id=void 0,this.nextTxId=0,this.txns={},this.options=b||{timeoutMs:1e4,keepaliveMs:3e4}}b.prototype.attach=function(a){return this.session.send({janus:'attach',plugin:a,"force-bundle":!0,"force-rtcp-mux":!0}).then((a)=>(this.id=a.data.id,a))},b.prototype.detach=function(){return this.send({janus:'detach'})},b.prototype.send=function(a){return this.session.send(Object.assign({handle_id:this.id},a))},b.prototype.sendMessage=function(a){return this.send({janus:'message',body:a})},b.prototype.sendJsep=function(a){return this.send({janus:'message',body:{},jsep:a})},b.prototype.sendTrickle=function(a){return this.send({janus:'trickle',candidate:a})},c.prototype.create=function(){return this.send({janus:'create'}).then((a)=>(this.id=a.data.id,a))},c.prototype.destroy=function(){return this.send({janus:'destroy'})},c.prototype.receive=function(b){if(a.exports.verbose&&console.debug('Incoming Janus signal: ',b),null!=b.transaction){var c=this.txns[b.transaction];'ack'===b.janus&&b.hint||null!=c&&(null!=c.timeout&&clearTimeout(c.timeout),delete this.txns[b.transaction],('error'===b.janus?c.reject:c.resolve)(b))}},c.prototype.send=function(b){return a.exports.verbose&&console.debug('Outgoing Janus signal: ',b),b=Object.assign({session_id:this.id,transaction:(this.nextTxId++).toString()},b),new Promise((a,c)=>{var d=null;this.options.timeoutMs&&(d=setTimeout(()=>{delete this.txns[b.transaction],c(new Error('Signalling message timed out.'))},this.options.timeoutMs)),this.txns[b.transaction]={resolve:a,reject:c,timeout:d},this.output(JSON.stringify(b)),this._resetKeepalive()})},c.prototype._resetKeepalive=function(){this.keepaliveTimeout&&clearTimeout(this.keepaliveTimeout),this.options.keepaliveMs&&(this.keepaliveTimeout=setTimeout(()=>this._keepalive(),this.options.keepaliveMs))},c.prototype._keepalive=function(){return this.send({janus:'keepalive'})},a.exports={JanusPluginHandle:b,JanusSession:c,verbose:!1}}]);
//# sourceMappingURL=naf-janus-adapter.min.js.map