(function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={i:d,l:!1,exports:{}};return a[d].call(e.exports,e,e.exports,b),e.l=!0,e.exports}var c={};return b.m=a,b.c=c,b.d=function(a,c,d){b.o(a,c)||Object.defineProperty(a,c,{configurable:!1,enumerable:!0,get:d})},b.n=function(a){var c=a&&a.__esModule?function(){return a['default']}:function(){return a};return b.d(c,'a',c),c},b.o=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},b.p='',b(b.s=1)})([function(a,b,c){(function(d){function e(){var a;try{a=b.storage.debug}catch(a){}return!a&&'undefined'!=typeof d&&'env'in d&&(a=d.env.DEBUG),a}b=a.exports=c(4),b.log=function(){return'object'==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},b.formatArgs=function(a){var d=this.useColors;if(a[0]=(d?'%c':'')+this.namespace+(d?' %c':' ')+a[0]+(d?'%c ':' ')+'+'+b.humanize(this.diff),!!d){var e='color: '+this.color;a.splice(1,0,e,'color: inherit');var c=0,f=0;a[0].replace(/%[a-zA-Z%]/g,function(a){'%%'===a||(c++,'%c'===a&&(f=c))}),a.splice(f,0,e)}},b.save=function(a){try{null==a?b.storage.removeItem('debug'):b.storage.debug=a}catch(a){}},b.load=e,b.useColors=function(){return'undefined'!=typeof window&&window.process&&'renderer'===window.process.type||('undefined'!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:'undefined'!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||'undefined'!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||'undefined'!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&31<=parseInt(RegExp.$1,10)||'undefined'!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))},b.storage='undefined'!=typeof chrome&&'undefined'!=typeof chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(a){}}(),b.colors=['#0000CC','#0000FF','#0033CC','#0033FF','#0066CC','#0066FF','#0099CC','#0099FF','#00CC00','#00CC33','#00CC66','#00CC99','#00CCCC','#00CCFF','#3300CC','#3300FF','#3333CC','#3333FF','#3366CC','#3366FF','#3399CC','#3399FF','#33CC00','#33CC33','#33CC66','#33CC99','#33CCCC','#33CCFF','#6600CC','#6600FF','#6633CC','#6633FF','#66CC00','#66CC33','#9900CC','#9900FF','#9933CC','#9933FF','#99CC00','#99CC33','#CC0000','#CC0033','#CC0066','#CC0099','#CC00CC','#CC00FF','#CC3300','#CC3333','#CC3366','#CC3399','#CC33CC','#CC33FF','#CC6600','#CC6633','#CC9900','#CC9933','#CCCC00','#CCCC33','#FF0000','#FF0033','#FF0066','#FF0099','#FF00CC','#FF00FF','#FF3300','#FF3333','#FF3366','#FF3399','#FF33CC','#FF33FF','#FF6600','#FF6633','#FF9900','#FF9933','#FFCC00','#FFCC33'],b.formatters.j=function(a){try{return JSON.stringify(a)}catch(a){return'[UnexpectedJSONParseError]: '+a.message}},b.enable(e())}).call(b,c(3))},function(a,b,c){function d(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d('next',a)},function(a){d('throw',a)})}return d('next')})}}function e(){return Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}var f=c(2),g=c(0)('naf-janus-adapter:debug'),h=c(0)('naf-janus-adapter:warn'),i=c(0)('naf-janus-adapter:error');const j={iceServers:[{urls:'stun:stun1.l.google.com:19302'},{urls:'stun:stun2.l.google.com:19302'}]};class k{constructor(){this.room=null,this.userId=e(),this.serverUrl=null,this.webRtcOptions={},this.ws=null,this.session=null,this.publisher=null,this.occupants={},this.mediaStreams={},this.pendingMediaRequests=new Map,this.timeOffsets=[],this.serverTimeRequests=0,this.avgTimeOffset=0,this.onWebsocketMessage=this.onWebsocketMessage.bind(this),this.onDataChannelMessage=this.onDataChannelMessage.bind(this)}setServerUrl(a){this.serverUrl=a}setApp(){}setRoom(a){try{this.room=parseInt(a)}catch(a){throw new Error('Room must be a positive integer.')}}setWebRtcOptions(a){this.webRtcOptions=a}setServerConnectListeners(a,b){this.connectSuccess=a,this.connectFailure=b}setRoomOccupantListener(a){this.onOccupantsChanged=a}setDataChannelListeners(a,b,c){this.onOccupantConnected=a,this.onOccupantDisconnected=b,this.onOccupantMessage=c}connect(){g(`connecting to ${this.serverUrl}`),this.ws=new WebSocket(this.serverUrl,'janus-protocol'),this.session=new f.JanusSession(this.ws.send.bind(this.ws)),this.ws.addEventListener('open',()=>this.onWebsocketOpen()),this.ws.addEventListener('message',this.onWebsocketMessage)}onWebsocketOpen(){var a=this;return d(function*(){yield a.updateTimeOffset(),yield a.session.create(),a.publisher=yield a.createPublisher(),a.setMediaStream(a.userId,a.publisher.mediaStream),yield Promise.all(a.publisher.initialOccupants.map(a.addOccupant.bind(a)))})()}onWebsocketMessage(a){this.session.receive(JSON.parse(a.data))}addOccupant(a){var b=this;return d(function*(){var c=yield b.createSubscriber(a);return b.occupants[a]=c,b.setMediaStream(a,c.mediaStream),b.onOccupantConnected(a),b.onOccupantsChanged(b.occupants),c})()}removeOccupant(a){this.occupants[a]&&(this.occupants[a]&&(this.occupants[a].conn.close(),delete this.occupants[a]),this.mediaStreams[a]&&delete this.mediaStreams[a],this.pendingMediaRequests.has(a)&&(this.pendingMediaRequests.get(a).reject('The user disconnected before the media stream was resolved.'),this.pendingMediaRequests.delete(a)),this.onOccupantDisconnected(a),this.onOccupantsChanged(this.occupants))}negotiateIce(a,b){return new Promise((c,d)=>{a.addEventListener('icecandidate',(a)=>{b.sendTrickle(a.candidate||null).then(()=>{a.candidate||c()},d)})})}negotiatePublisherMedia(a,b){return d(function*(){g('pub sending offer and setting remote/local description');var c=yield a.createOffer(),d=a.setLocalDescription(c),e=b.sendJsep(c).then(function({jsep:b}){return a.setRemoteDescription(b)});return yield Promise.all([d,e])})()}negotiateSubscriberMedia(a,b,c){return d(function*(){g('sub sending answer and setting remote/local description');var d=yield a.setRemoteDescription(c),e=yield a.createAnswer(),f=a.setLocalDescription(e),h=b.sendJsep(e);return yield Promise.all([f,h])})()}createPublisher(){var a=this;return d(function*(){var b=new f.JanusPluginHandle(a.session);g('pub waiting for sfu'),yield b.attach('janus.plugin.sfu');var c=new RTCPeerConnection(j);a.negotiateIce(c,b).catch(function(a){return i('Error negotiating ICE candidates: %o',a)});var d=c.createDataChannel('unreliable',{ordered:!1,maxRetransmits:0});d.addEventListener('message',a.onDataChannelMessage);var e=c.createDataChannel('reliable',{ordered:!0});e.addEventListener('message',a.onDataChannelMessage);var k;a.localMediaStream?(k=a.localMediaStream,c.addStream(a.localMediaStream)):h('localMediaStream not set. Will not publish audio or video'),a.negotiatePublisherMedia(c,b).catch(function(a){return i('Error negotiating media: %o',a)}),g('pub waiting for webrtcup'),yield new Promise(function(a){return b.on('webrtcup',a)}),a.connectSuccess(a.userId),b.on('event',function(b){var c=b.plugindata.data;'join'==c.event&&c.room_id==a.room?a.addOccupant(c.user_id):'leave'==c.event&&c.room_id==a.room&&a.removeOccupant(c.user_id)}),g('pub waiting for join');var l=yield a.sendJoin(b,{notifications:!0,data:!0}),m=l.plugindata.data.response.users[a.room]||[];return g('publisher ready'),{handle:b,initialOccupants:m,reliableChannel:e,unreliableChannel:d,mediaStream:k,conn:c}})()}configureSubscriberSdp(a){return-1===navigator.userAgent.indexOf('Android')?a.replace('a=rtcp-fb:107 goog-remb\r\n','a=rtcp-fb:107 goog-remb\r\na=rtcp-fb:107 transport-cc\r\na=fmtp:107 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f\r\n'):a.replace('a=rtcp-fb:107 goog-remb\r\n','a=rtcp-fb:107 goog-remb\r\na=rtcp-fb:107 transport-cc\r\na=fmtp:107 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42001f\r\n')}createSubscriber(a){var b=this;return d(function*(){var c=new f.JanusPluginHandle(b.session);g('sub waiting for sfu'),yield c.attach('janus.plugin.sfu');var d=new RTCPeerConnection(j);b.negotiateIce(d,c).catch(function(a){return i('Error negotiating ICE candidates: %o',a)}),g('sub waiting for join');const e=yield b.sendJoin(c,{media:a});e.jsep.sdp=b.configureSubscriberSdp(e.jsep.sdp),b.negotiateSubscriberMedia(d,c,e.jsep).catch(function(a){return i('Error negotiating media: %o',a)}),g('sub waiting for webrtcup'),yield new Promise(function(a){return c.on('webrtcup',a)});var h=d.getRemoteStreams(),k=0<h.length?h[0]:null;return g('subscriber ready'),{handle:c,mediaStream:k,conn:d}})()}sendJoin(a,b){return a.sendMessage({kind:'join',room_id:this.room,user_id:this.userId,subscribe:b})}onDataChannelMessage(a){var b=JSON.parse(a.data);b.dataType&&this.onOccupantMessage(null,b.dataType,b.data)}shouldStartConnectionTo(){return!0}startStreamConnection(){}closeStreamConnection(){}getConnectStatus(a){return this.occupants[a]?NAF.adapters.IS_CONNECTED:NAF.adapters.NOT_CONNECTED}updateTimeOffset(){var a=this;return d(function*(){const b=Date.now()+a.avgTimeOffset,c=yield fetch(document.location.href,{method:'HEAD',cache:'no-cache'}),d=new Date(c.headers.get('Date')).getTime()+1e3/2,e=Date.now(),f=d+(e-b)/2-e;a.serverTimeRequests++,10>=a.serverTimeRequests?a.timeOffsets.push(f):a.timeOffsets[a.serverTimeRequests%10]=f,a.avgTimeOffset=a.timeOffsets.reduce(function(a,b){return a+=b},0)/a.timeOffsets.length,10<a.serverTimeRequests?setTimeout(function(){return a.updateTimeOffset()},300000):a.updateTimeOffset()})()}getServerTime(){return Date.now()+this.avgTimeOffset}getMediaStream(a){if(this.mediaStreams[a])return g('Already had audio for '+a),Promise.resolve(this.mediaStreams[a]);if(g('Waiting on audio for '+a),!this.pendingMediaRequests.has(a)){const b=new Promise((b,c)=>{this.pendingMediaRequests.set(a,{resolve:b,reject:c})});this.pendingMediaRequests.get(a).promise=b}return this.pendingMediaRequests.get(a).promise}setMediaStream(a,b){this.mediaStreams[a]=b,this.pendingMediaRequests.has(a)&&this.pendingMediaRequests.get(a).resolve(b)}setLocalMediaStream(a){this.publisher&&console.warn('setLocalMediaStream called after publisher created. Will not publish new stream.'),this.localMediaStream=a}enableMicrophone(a){if(this.publisher&&this.publisher.mediaStream){var b=this.publisher.mediaStream.getAudioTracks();0<b.length&&(b[0].enabled=a)}}sendData(a,b,c){this.publisher.unreliableChannel.send(JSON.stringify({clientId:a,dataType:b,data:c}))}sendDataGuaranteed(a,b,c){this.publisher.reliableChannel.send(JSON.stringify({clientId:a,dataType:b,data:c}))}broadcastData(a,b){this.publisher.unreliableChannel.send(JSON.stringify({dataType:a,data:b}))}broadcastDataGuaranteed(a,b){this.publisher.reliableChannel.send(JSON.stringify({dataType:a,data:b}))}}NAF.adapters.register('janus',k),a.exports=k},function(a){function b(a){this.session=a,this.id=void 0}function c(a,b){this.output=a,this.id=void 0,this.nextTxId=0,this.txns={},this.eventHandlers={},this.options=Object.assign({verbose:!1,timeoutMs:1e4,keepaliveMs:3e4},b)}b.prototype.attach=function(a){return this.session.send('attach',{plugin:a,"force-bundle":!0,"force-rtcp-mux":!0}).then((a)=>(this.id=a.data.id,a))},b.prototype.detach=function(){return this.send('detach')},b.prototype.on=function(a,b){return this.session.on(a,(a)=>{a.sender==this.id&&b(a)})},b.prototype.send=function(a,b){return this.session.send(a,Object.assign({handle_id:this.id},b))},b.prototype.sendMessage=function(a){return this.send('message',{body:a})},b.prototype.sendJsep=function(a){return this.send('message',{body:{},jsep:a})},b.prototype.sendTrickle=function(a){return this.send('trickle',{candidate:a})},c.prototype.create=function(){return this.send('create').then((a)=>(this.id=a.data.id,a))},c.prototype.destroy=function(){return this.send('destroy').then(()=>{this._killKeepalive()})},c.prototype.isError=function(a){return'error'===a.janus},c.prototype.on=function(a,b){var c=this.eventHandlers[a];null==c&&(c=this.eventHandlers[a]=[]),c.push(b)},c.prototype.receive=function(a){this.options.verbose&&console.debug('Incoming Janus signal: ',a),a.session_id!=this.id&&console.warn('Incorrect session ID received in Janus signalling message: was '+a.session_id+', expected '+this.id+'.');var b=a.janus,c=this.eventHandlers[b];if(null!=c)for(var d=0;d<c.length;d++)c[d](a);if(null!=a.transaction){var e=this.txns[a.transaction];if(null==e)return;if('ack'===b&&'message'==e.type)return;null!=e.timeout&&clearTimeout(e.timeout),delete this.txns[a.transaction],(this.isError(a)?e.reject:e.resolve)(a)}},c.prototype.send=function(a,b){var c=(this.nextTxId++).toString();return b=Object.assign({janus:a,transaction:c},b),null!=this.id&&(b=Object.assign({session_id:this.id},b)),this.options.verbose&&console.debug('Outgoing Janus signal: ',b),new Promise((d,e)=>{var f=null;this.options.timeoutMs&&(f=setTimeout(()=>{delete this.txns[b.transaction],e(new Error('Signalling message with txid '+c+' timed out.'))},this.options.timeoutMs)),this.txns[b.transaction]={resolve:d,reject:e,timeout:f,type:a},this.output(JSON.stringify(b)),this._resetKeepalive()})},c.prototype._keepalive=function(){return this.send('keepalive')},c.prototype._killKeepalive=function(){this.keepaliveTimeout&&clearTimeout(this.keepaliveTimeout)},c.prototype._resetKeepalive=function(){this._killKeepalive(),this.options.keepaliveMs&&(this.keepaliveTimeout=setTimeout(()=>this._keepalive(),this.options.keepaliveMs))},a.exports={JanusPluginHandle:b,JanusSession:c}},function(a){function b(){throw new Error('setTimeout has not been defined')}function c(){throw new Error('clearTimeout has not been defined')}function d(a){if(j===setTimeout)return setTimeout(a,0);if((j===b||!j)&&setTimeout)return j=setTimeout,setTimeout(a,0);try{return j(a,0)}catch(b){try{return j.call(null,a,0)}catch(b){return j.call(this,a,0)}}}function e(a){if(k===clearTimeout)return clearTimeout(a);if((k===c||!k)&&clearTimeout)return k=clearTimeout,clearTimeout(a);try{return k(a)}catch(b){try{return k.call(null,a)}catch(b){return k.call(this,a)}}}function f(){o&&m&&(o=!1,m.length?n=m.concat(n):p=-1,n.length&&g())}function g(){if(!o){var a=d(f);o=!0;for(var b=n.length;b;){for(m=n,n=[];++p<b;)m&&m[p].run();p=-1,b=n.length}m=null,o=!1,e(a)}}function h(a,b){this.fun=a,this.array=b}function i(){}var j,k,l=a.exports={};(function(){try{j='function'==typeof setTimeout?setTimeout:b}catch(a){j=b}try{k='function'==typeof clearTimeout?clearTimeout:c}catch(a){k=c}})();var m,n=[],o=!1,p=-1;l.nextTick=function(a){var b=Array(arguments.length-1);if(1<arguments.length)for(var c=1;c<arguments.length;c++)b[c-1]=arguments[c];n.push(new h(a,b)),1!==n.length||o||d(g)},h.prototype.run=function(){this.fun.apply(null,this.array)},l.title='browser',l.browser=!0,l.env={},l.argv=[],l.version='',l.versions={},l.on=i,l.addListener=i,l.once=i,l.off=i,l.removeListener=i,l.removeAllListeners=i,l.emit=i,l.prependListener=i,l.prependOnceListener=i,l.listeners=function(){return[]},l.binding=function(){throw new Error('process.binding is not supported')},l.cwd=function(){return'/'},l.chdir=function(){throw new Error('process.chdir is not supported')},l.umask=function(){return 0}},function(a,b,c){function d(a){var c,d=0;for(c in a)d=(d<<5)-d+a.charCodeAt(c),d|=0;return b.colors[Math.abs(d)%b.colors.length]}function e(a){function c(){if(c.enabled){var a=c,d=+new Date,f=d-(e||d);a.diff=f,a.prev=e,a.curr=d,e=d;for(var g=Array(arguments.length),h=0;h<g.length;h++)g[h]=arguments[h];g[0]=b.coerce(g[0]),'string'!=typeof g[0]&&g.unshift('%O');var i=0;g[0]=g[0].replace(/%([a-zA-Z%])/g,function(c,d){if('%%'===c)return c;i++;var e=b.formatters[d];if('function'==typeof e){var f=g[i];c=e.call(a,f),g.splice(i,1),i--}return c}),b.formatArgs.call(a,g);var j=c.log||b.log||console.log.bind(console);j.apply(a,g)}}var e;return c.namespace=a,c.enabled=b.enabled(a),c.useColors=b.useColors(),c.color=d(a),c.destroy=f,'function'==typeof b.init&&b.init(c),b.instances.push(c),c}function f(){var a=b.instances.indexOf(this);return-1!==a&&(b.instances.splice(a,1),!0)}b=a.exports=e.debug=e['default']=e,b.coerce=function(a){return a instanceof Error?a.stack||a.message:a},b.disable=function(){b.enable('')},b.enable=function(a){b.save(a),b.names=[],b.skips=[];var c,d=('string'==typeof a?a:'').split(/[\s,]+/),e=d.length;for(c=0;c<e;c++)d[c]&&(a=d[c].replace(/\*/g,'.*?'),'-'===a[0]?b.skips.push(new RegExp('^'+a.substr(1)+'$')):b.names.push(new RegExp('^'+a+'$')));for(c=0;c<b.instances.length;c++){var f=b.instances[c];f.enabled=b.enabled(f.namespace)}},b.enabled=function(a){if('*'===a[a.length-1])return!0;var c,d;for(c=0,d=b.skips.length;c<d;c++)if(b.skips[c].test(a))return!1;for(c=0,d=b.names.length;c<d;c++)if(b.names[c].test(a))return!0;return!1},b.humanize=c(5),b.instances=[],b.names=[],b.skips=[],b.formatters={}},function(a){function b(a){if(a+='',!(100<a.length)){var b=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(a);if(b){var c=parseFloat(b[1]),e=(b[2]||'ms').toLowerCase();return'years'===e||'year'===e||'yrs'===e||'yr'===e||'y'===e?c*d:'days'===e||'day'===e||'d'===e?c*h:'hours'===e||'hour'===e||'hrs'===e||'hr'===e||'h'===e?c*j:'minutes'===e||'minute'===e||'mins'===e||'min'===e||'m'===e?c*i:'seconds'===e||'second'===e||'secs'===e||'sec'===e||'s'===e?c*g:'milliseconds'===e||'millisecond'===e||'msecs'===e||'msec'===e||'ms'===e?c:void 0}}}function c(a){var b=Math.round;return a>=h?b(a/h)+'d':a>=j?b(a/j)+'h':a>=i?b(a/i)+'m':a>=g?b(a/g)+'s':a+'ms'}function e(a){return f(a,h,'day')||f(a,j,'hour')||f(a,i,'minute')||f(a,g,'second')||a+' ms'}function f(a,b,c){return a<b?void 0:a<1.5*b?Math.floor(a/b)+' '+c:Math.ceil(a/b)+' '+c+'s'}var g=1e3,i=60*g,j=60*i,h=24*j,d=365.25*h;a.exports=function(a,d){d=d||{};var f=typeof a;if('string'==f&&0<a.length)return b(a);if('number'==f&&!1===isNaN(a))return d.long?e(a):c(a);throw new Error('val is not a non-empty string or a valid number. val='+JSON.stringify(a))}}]);
//# sourceMappingURL=naf-janus-adapter.min.js.map